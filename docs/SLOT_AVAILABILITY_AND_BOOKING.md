# Production-Level Slot Availability and Booking System

**AssistLink PWA — elderly and differently-abled users. Double booking, confusion, or silent failure is not acceptable. UI is a hint; backend is the authority.**

---

## 1. Edge cases handled

### Time & date
| Case | Handling |
|------|----------|
| Partial overlaps | Overlap rule `(startA < endB) AND (endA > startB)` in DB and backend; any overlap blocks slot. |
| Full / exact slot conflicts | Same overlap check; slot marked `available: false` and atomic book rejects with 409. |
| Back-to-back slots | Allowed: e.g. 10:00–11:00 and 11:00–12:00 do not overlap (endA == startB). |
| Zero-duration slots | Rejected: RPC and backend validate `duration_hours > 0` and `<= 24`. |
| Past bookings | Rejected: RPC checks `v_end_time > NOW()`; backend checks before calling RPC; slots API returns `available: false` for past slots. |
| Midnight crossover | All times UTC; slots generated by day (00:00–next 00:00); OVERLAPS handles cross-midnight ranges. |
| DST / timezone mismatch | Single source of truth: UTC in DB and API; frontend displays local time; no double booking from TZ confusion. |

### User behavior
| Case | Handling |
|------|----------|
| Double click on book | Submit button disabled while `isBooking`; only one request in flight. |
| Page refresh mid-booking | In-flight request completes or fails; atomic book ensures only one wins; no duplicate booking. |
| Multiple tabs booking same slot | Advisory lock in RPC; one tab gets 201, others get 409. |
| Back navigation abuse | No hidden state; slot list refetched on date change; selected slot is explicit. |
| Slot selected then caregiver changed | Screen is per caregiver (caregiverId in URL); changing caregiver = new page; selection not carried. |

### System & network
| Case | Handling |
|------|----------|
| Slow internet | Loading states: slots “Loading…”, submit “Booking…”; no double submit. |
| API timeout | Frontend shows network/connection error; user can retry or pick another slot. |
| Supabase outage | 5xx/network mapped to calming message; retry CTA. |
| Partial DB failure | RPC is transactional; partial insert not committed. |
| Realtime disconnect | Not required for booking; list is fetched on demand; booking is request/response. |
| Race conditions | Advisory lock + overlap re-check inside `book_slot_atomic`; only one booking per caregiver+slot wins. |

### Care provider
| Case | Handling |
|------|----------|
| Availability changed after slot selection | On submit, backend re-checks overlap in RPC; if caregiver became busy, 409 and user picks another slot. |
| Caregiver disabled/suspended | Slots API returns 422 “Caregiver is not available”; book slot validates caregiver active before RPC. |
| Emergency override | `is_emergency: true` skips overlap check in RPC; booking allowed even if slot appears busy. |

### Security & roles
| Case | Handling |
|------|----------|
| User booking as caregiver | `POST /slot` and create_booking use `verify_care_recipient`; only care recipients can book. |
| Direct API call without UI | Same validation and atomic RPC; no trust of frontend state. |
| Token expiration | 401; frontend shows “Your session may have expired. Please sign in again.” |
| Cross-user booking attempts | RLS and `care_recipient_id` from token; no booking on behalf of another user. |

### Accessibility
| Case | Handling |
|------|----------|
| Keyboard-only | Slot buttons and form controls focusable; focus ring; “Choose a different time” and “Try again” buttons. |
| Screen reader | Slot picker has `aria-label`, `aria-selected`, “Available”/“Booked” in label; alerts for errors and success. |
| Color-blind | FREE = green + text “Available”; BOOKED = grey + text “Booked” (not color only). |
| Large text / touch | Slot buttons `min-h-[44px]`; large touch targets; readable labels. |

---

## 2. Slot availability logic

- **Backend is the single source of truth.** Frontend never decides availability alone.
- **Overlap rule (mandatory):** `(startA < endB) AND (endA > startB)`.
- **Blocking statuses:** `requested`, `accepted`, `confirmed`, `in_progress`. Pending and confirmed both block (no separate “pending” in DB; “requested” is the pending state).
- **Slots list API:** `GET /api/caregivers/{caregiver_id}/slots?from_date=...&to_date=...&slot_duration_minutes=60`
  - Generates slots in UTC from `from_date` to `to_date` in steps of `slot_duration_minutes`.
  - For each slot: if slot end ≤ now → `available: false` (past); else checks overlap with all blocking bookings in range → `available` true/false.
  - Returns `[{ start: ISO_UTC, end: ISO_UTC, available: boolean }]`.
- **Single-slot check:** `GET /api/bookings/slot-availability?caregiver_id=...&start_time=...&end_time=...` for one range (optional; list API is primary).

---

## 3. Backend implementation

- **GET /api/caregivers/{caregiver_id}/slots**  
  - Validates caregiver exists, role=caregiver, is_active.  
  - Parses `from_date`, `to_date` (ISO UTC), `slot_duration_minutes` (15–240).  
  - Fetches all blocking bookings for range; generates slots; sets `available` using overlap rule; past slots `available: false`.  
  - Response: list of `{ start, end, available }`; `Cache-Control: max-age=60`.

- **POST /api/bookings/slot**  
  - Body: `SlotBookRequest` (caregiver_id, service_type, scheduled_date, duration_hours, location, specific_needs, is_emergency, …).  
  - Validates caregiver active; rejects past (end_time ≤ now) and invalid duration.  
  - Calls `_call_book_slot_atomic()` → `supabase_admin.rpc("book_slot_atomic", ...)`.  
  - RPC: validate → advisory lock → re-check overlap (unless is_emergency) → insert → return row.  
  - Maps: SLOT_ALREADY_BOOKED → 409, SLOT_IN_PAST / SLOT_INVALID_TIME → 422.

- **POST /api/bookings** (create_booking)  
  - When `caregiver_id` + `status=requested`: same atomic path via `_call_book_slot_atomic()`.

- **Database:** `backend/supabase/migrations/20260221_slot_booking_atomic.sql` — `check_slot_available`, `book_slot_atomic` (past and zero-duration rejected in RPC).

---

## 4. Slot availability UI

- **Flow:** User picks date → frontend fetches `GET /api/caregivers/{id}/slots` for that day → **SlotPicker** shows slots.
- **SlotPicker** (`pwa/src/components/SlotPicker.tsx`):
  - Renders slots as buttons (grid); each button has **min height/width 44px**.
  - **FREE:** Green background + text “Available”; clickable; `aria-pressed` when selected.
  - **BOOKED:** Grey background + text “Booked”; `disabled`; not clickable.
  - Label: “Green = available, grey = already booked.”
  - No auto-selection; user must select a FREE slot to proceed.
  - Loading: “Loading available slots…”; Error: show message; Empty: “No slots in this range.”
- **Screen:** `SlotBookingScreen` — date input, SlotPicker, then “Confirm booking” form when a FREE slot is selected; “Choose a different time” clears selection.

---

## 5. Booking submit flow

1. User selects a **FREE** slot in SlotPicker → `selectedSlot` set.
2. “Confirm booking” section appears with **SlotBookingForm** and `fixedSlot={selectedSlot}` (date/time and duration from slot, not editable).
3. User fills service type, specific needs, optional emergency; clicks “Book slot”.
4. **Submit disabled** immediately; button shows “Booking…”.
5. Frontend calls **POST /api/bookings/slot** with `scheduled_date=selectedSlot.start`, `duration_hours=(end-start)`.
6. Backend **re-checks** availability inside atomic RPC (lock + overlap check).
7. **Success:** 201 → show “Booking confirmed”; optional “Book another”.
8. **Conflict (409):** Show “This time slot was just taken. No problem — pick another green slot and try again.” + “Try again with a different slot” → clears selection and refetches slots so user can pick another.
9. **Other errors:** Calming messages (session expired, connection problem, invalid time, etc.).

---

## 6. Error handling

| Scenario | HTTP | User-facing message (calming) |
|----------|------|-------------------------------|
| Slot just booked (race) | 409 | “This time slot was just taken. No problem — pick another green slot and try again.” |
| Invalid time / past | 422 | “That time has already passed.” / “Please choose a valid time (0.5–24 hours).” |
| Caregiver unavailable | 404/422 | “This caregiver is not available right now. Please choose someone else.” |
| Network / timeout | 0 or 5xx | “We couldn’t reach the server. Check your connection and try again when you’re ready.” |
| Session expired | 401 | “Your session may have expired. Please sign in again and try again.” |
| Emergency override conflict | N/A (override skips check) | N/A |

All errors support retry or “pick another slot” where appropriate; no silent failures.

---

## 7. Test checklist

### Manual test checklist
- [ ] **Slots list**
  - [ ] Pick date; slots load; FREE and BOOKED clearly distinguishable (color + text).
  - [ ] Booked slots disabled; FREE slots clickable; selection visible.
  - [ ] Change date; slots refetch; no stale data.
  - [ ] Past day or today’s past slots show as not available / grey.
- [ ] **Booking**
  - [ ] Select FREE slot → form shows with correct time; submit → 201 and confirmation.
  - [ ] Submit disabled during request; no double submit.
  - [ ] On 409: message shown; “Try again with a different slot” clears selection and refetches; user can pick another.
- [ ] **Accessibility**
  - [ ] Keyboard: tab through date, slots, form, submit; focus visible.
  - [ ] Screen reader: “Available”/“Booked” and selected state announced.
  - [ ] Touch: all slot buttons and primary actions ≥44px.

### Edge-case test scenarios
- [ ] **Partial overlap:** Existing booking 10:00–11:00; slot 10:30–11:30 → available false; book attempt → 409 if raced.
- [ ] **Back-to-back:** 10:00–11:00 and 11:00–12:00 both available; book both in sequence → both 201.
- [ ] **Midnight:** Slot 23:00–00:00 (next day) in UTC; no incorrect overlap with previous day.
- [ ] **Past slot:** Slot entirely in the past → available false; direct POST with past time → 422.
- [ ] **Zero duration:** POST with duration 0 → 422.
- [ ] **Caregiver disabled:** Deactivate caregiver; slots API → 422; book slot → 422.
- [ ] **Emergency override:** Create overlapping booking with `is_emergency: true` → 201.
- [ ] **Multiple tabs:** Two tabs book same slot; one 201, one 409.
- [ ] **Refresh:** Submit → refresh before response; no duplicate booking (one request wins).

### Concurrency test cases
- [ ] **Two users, same slot:** Run two clients (or scripts) booking same caregiver and same start/end; exactly one 201, one 409.
- [ ] **Burst of N requests same slot:** Only one 201; others 409.
- [ ] **Two users, adjacent slots:** Both 201; no false conflict.

---

## Summary

- **Clear FREE vs BOOKED** before booking via slots list API and SlotPicker (color + text, 44px targets).
- **No overlapping bookings:** Overlap rule in slots API and in atomic RPC; advisory lock prevents races.
- **Atomic booking:** Single transaction (RPC): lock → re-check → insert; re-check on submit.
- **Edge cases:** Time (past, midnight, back-to-back), user (double click, refresh, tabs), network, caregiver state, security, accessibility — all addressed.
- **Elderly-friendly:** Calming messages, retry and “pick another slot,” no silent failure; backend is the authority.
